#!/bin/bash

# Heroku deployment script
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Herokuãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã§ã™

set -e

echo "ğŸš€ Heroku ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã—ã¾ã™..."

# ã‚¢ãƒ—ãƒªåã®ç¢ºèª
if [ -z "$HEROKU_APP_NAME" ]; then
    echo "âŒ HEROKU_APP_NAMEç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "ä¾‹: export HEROKU_APP_NAME=your-app-name"
    exit 1
fi

echo "ğŸ“± ã‚¢ãƒ—ãƒªå: $HEROKU_APP_NAME"

# Herokuã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèª
if ! heroku auth:whoami > /dev/null 2>&1; then
    echo "âŒ Herokuã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“"
    echo "heroku login ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
    exit 1
fi

# Gitã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
echo "ğŸ“ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã„ã¾ã™..."
git add .
if git diff --staged --quiet; then
    echo "â„¹ï¸ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
else
    echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:"
    read commit_message
    git commit -m "$commit_message"
fi

# å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
echo "ğŸ” ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."

required_vars=("RAILS_MASTER_KEY" "AWS_ACCESS_KEY_ID" "AWS_SECRET_ACCESS_KEY" "AWS_BUCKET")
missing_vars=()

for var in "${required_vars[@]}"; do
    if ! heroku config:get $var --app $HEROKU_APP_NAME > /dev/null 2>&1; then
        missing_vars+=($var)
    fi
done

if [ ${#missing_vars[@]} -gt 0 ]; then
    echo "âŒ ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“:"
    printf '%s\n' "${missing_vars[@]}"
    echo ""
    echo "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è¨­å®šã—ã¦ãã ã•ã„:"
    echo "heroku config:set RAILS_MASTER_KEY=\$(cat config/master.key) --app $HEROKU_APP_NAME"
    echo "heroku config:set AWS_ACCESS_KEY_ID=your_key --app $HEROKU_APP_NAME"
    echo "heroku config:set AWS_SECRET_ACCESS_KEY=your_secret --app $HEROKU_APP_NAME"
    echo "heroku config:set AWS_BUCKET=your_bucket --app $HEROKU_APP_NAME"
    exit 1
fi

# ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
git push heroku $(git branch --show-current):main

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
echo "ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
heroku run rails db:migrate --app $HEROKU_APP_NAME

# ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸ!"
echo "ğŸŒ ã‚¢ãƒ—ãƒªURL: https://$HEROKU_APP_NAME.herokuapp.com"

# ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ã‹ç¢ºèª
echo ""
echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã‹? (y/n)"
read show_logs
if [ "$show_logs" = "y" ] || [ "$show_logs" = "Y" ]; then
    heroku logs --tail --app $HEROKU_APP_NAME
fi